---
import { ImageProps, getImageSize, classToString } from '../components_shared';

export interface Props extends ImageProps {};
const props = Astro.props;

const size = getImageSize(props.sizes);
---

<img class={classToString(props.class)} src={props.src} alt={props.alt} width={size?.width} height={size?.height} draggable={ props.draggable === true ? 'true' : 'false' } loading={ props.lazy !== false ? 'lazy' : undefined } data-maddsua-component="astro:ssgassets:img" />

<script>

	export const asyncSleep = (timeout: number) => new Promise<void>(resolve => setTimeout(resolve, timeout));

	document.querySelectorAll<HTMLImageElement>('img[loading="lazy"][data-maddsua-component]').forEach(image => {

		if (image.complete) return;

		image.style.transition = `opacity 500ms ease`;
		image.style.opacity = '0';

		image.onload = async () => {

			await asyncSleep(10);
			image.style.opacity = '1';

			await asyncSleep(500);
			image.style.transition = '';
			image.style.opacity = '';
		};
	});

</script>
